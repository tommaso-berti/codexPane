# React SPA Deployment ‚Äî VPS + NGINX + HTTPS + GitHub Actions

This guide builds and deploys a **React** single-page application (SPA) to a **Linux VPS**, configures **NGINX** for client-side routing, enables **HTTPS** via **Certbot**, sets **Aruba DNS**, and wires **CI/CD** via **GitHub Actions**.

## Recommended vps structure

~~~
/srv/www/
‚îú‚îÄ‚îÄ react-apps/
‚îÇ   ‚îî‚îÄ‚îÄ my-react-app/
‚îÇ       ‚îî‚îÄ‚îÄ build/          ‚Üê Generated by `npm run build`
‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îî‚îÄ‚îÄ my-react-app/
‚îÇ       ‚îú‚îÄ‚îÄ access.log
‚îÇ       ‚îî‚îÄ‚îÄ error.log
‚îú‚îÄ‚îÄ configs/
    ‚îî‚îÄ‚îÄ nginx/
        ‚îî‚îÄ‚îÄ my-react-app.conf
~~~

## Prerequisites

- Linux VPS (Ubuntu/Debian) with public IP
- Non-root user with `sudo` (e.g., `<deploy-user>`)
- React app in GitHub (CRA/Vite/other SPA; **not SSR**)
- Domain or subdomain on Aruba (e.g., `app.example.com`)

## Prepare the vps node nginx firewall

~~~bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y nginx git curl ufw

# Node.js LTS (example: Node 20)
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# Firewall
sudo ufw allow OpenSSH
sudo ufw allow 'Nginx Full'
sudo ufw --force enable
sudo ufw status
~~~

Create base directories:

~~~bash
sudo mkdir -p /srv/www/react-apps/<app-name>/build
sudo mkdir -p /srv/www/logs/<app-name>
sudo mkdir -p /srv/www/configs/nginx
~~~

## Clone and build the react app

~~~bash
cd /srv/www/react-apps/<app-name>
sudo git clone https://github.com/<your-user>/<repo>.git .
sudo npm ci
sudo npm run build
~~~

Result: production assets in `/srv/www/react-apps/<app-name>/build`.

## Configure nginx for spa routing

Create `/srv/www/configs/nginx/<app-name>.conf`:

~~~nginx
server {
    listen 80;
    server_name <domain>;  # e.g. app.example.com

    root /srv/www/react-apps/<app-name>/build;
    index index.html;

    access_log /srv/www/logs/<app-name>/access.log;
    error_log  /srv/www/logs/<app-name>/error.log;

    # SPA routing: fallback to index.html
    location / {
        try_files $uri /index.html;
    }
}
~~~

Enable and reload:

~~~bash
sudo ln -s /srv/www/configs/nginx/<app-name>.conf /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
~~~

## Point dns on aruba

Add **A** record:

| Type | Host (Name) | Value (IP) |
|-----:|--------------|------------|
|  A   | `app`        | `<VPS-IP>` |

Result: `app.yourdomain.com` ‚Üí `<VPS-IP>`.

## Enable https with certbot

~~~bash
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d <domain>   # e.g. -d app.example.com
~~~

## Fix permissions

~~~bash
sudo chown -R www-data:www-data /srv/www/react-apps/<app-name>/build
sudo chmod -R 755 /srv/www/react-apps/<app-name>/build
~~~

## All in one deploy script

Create `deploy-react-app.sh` (store on VPS or `~/scripts`):

~~~bash
#!/bin/bash
set -euo pipefail

if [[ $# -ne 3 ]]; then
  echo "Usage: $0 <project-name> <github-repo-url> <domain>"
  echo "Example: $0 codexpane https://github.com/tommaso-berti/codexPane.git codexpane.tommasoberti.com"
  exit 1
fi

PROJECT_NAME="$1"
REPO_URL="$2"
DOMAIN="$3"

ROOT_DIR="/srv/www/react-apps/$PROJECT_NAME"
LOG_DIR="/srv/www/logs/$PROJECT_NAME"
CONF_DIR="/srv/www/configs/nginx"
CONF_FILE="$CONF_DIR/$PROJECT_NAME.conf"

echo "üìÅ Creating folders..."
mkdir -p "$ROOT_DIR" "$LOG_DIR" "$CONF_DIR"
cd "$ROOT_DIR"

echo "üîΩ Preparing repository..."
if [[ -d .git ]]; then
  git fetch --all --prune
  DEFAULT_BRANCH="$(git remote show origin | awk '/HEAD branch/ {print $NF}')"
  DEFAULT_BRANCH="${DEFAULT_BRANCH:-main}"
  git reset --hard "origin/$DEFAULT_BRANCH"
  git clean -fdx
else
  if [[ -n "$(ls -A 2>/dev/null || true)" ]]; then
    echo "‚ùå $ROOT_DIR esiste ma non √® un repo Git. Svuota o rimuovi la cartella e riprova."
    exit 1
  fi
  git clone "$REPO_URL" .
fi

echo "üì¶ Installing dependencies & building..."
if command -v npm >/dev/null 2>&1; then
  npm ci --no-audit --no-fund || npm install
  npm run build
else
  echo "‚ùå npm non trovato"; exit 1
fi

# Vite => dist, CRA => build
if [[ -d dist ]]; then
  BUILD_DIR="$ROOT_DIR/dist"
elif [[ -d build ]]; then
  BUILD_DIR="$ROOT_DIR/build"
else
  echo "‚ùå Cartella di build non trovata (n√© dist n√© build)"; exit 1
fi

echo "üîê Setting permissions on $BUILD_DIR..."
chown -R www-data:www-data "$BUILD_DIR"
chmod -R 755 "$BUILD_DIR"

echo "‚öôÔ∏è Writing NGINX config for $DOMAIN..."
cat > "$CONF_FILE" <<EOF
server {
    listen 80;
    server_name $DOMAIN;

    root $BUILD_DIR;
    index index.html;

    access_log /srv/www/logs/$PROJECT_NAME/access.log;
    error_log  /srv/www/logs/$PROJECT_NAME/error.log;

    location / {
        try_files \$uri \$uri/ /index.html;
    }
}
EOF

ln -sf "$CONF_FILE" "/etc/nginx/sites-enabled/$PROJECT_NAME.conf"

echo "üöÄ Testing & reloading NGINX..."
nginx -t && systemctl reload nginx

read -r -p "üîí Enable HTTPS with Certbot for $DOMAIN? (y/n): " R
if [[ "$R" =~ ^[Yy]$ ]]; then
  echo "‚ÑπÔ∏è A record seen from this server:"
  getent ahostsv4 "$DOMAIN" 2>/dev/null | awk '{print $1}' | sort -u || true
  certbot --nginx -d "$DOMAIN"
fi

echo "‚úÖ Done. Visit: http://$DOMAIN"
~~~

Make it executable:

~~~bash
chmod +x deploy-react-app.sh
~~~

## Build on the vps

**Generate a deploy SSH key (local):**

~~~bash
ssh-keygen -t rsa -b 4096 -C "github-deploy" -f ~/.ssh/id_rsa_github -N ""
ssh-copy-id -i ~/.ssh/id_rsa_github.pub <deploy-user>@<VPS-IP>
~~~

**GitHub repository secrets:**

- `SSH_PRIVATE_KEY` ‚Üí content of `~/.ssh/id_rsa_github`
- `VPS_HOST` ‚Üí `<VPS-IP>`
- `VPS_USER` ‚Üí `<deploy-user>`

**Workflow** `.github/workflows/deploy.yml`:

~~~yaml
name: Deploy React (build on VPS)
on:
  push:
    branches: [ main ]
concurrency: deploy-react
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build & deploy on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /srv/www/react-apps/<app-name>
            git pull origin main
            npm ci
            npm run build
            chown -R www-data:www-data build
            systemctl reload nginx
~~~

**Pros:** minimal setup. **Cons:** build depends on VPS toolchain.

## Build in ci upload artifacts

**Same SSH key + secrets as above.**

**Workflow** `.github/workflows/deploy.yml`:

~~~yaml
name: Deploy React (build in CI)
on:
  push:
    branches: [ main ]
concurrency: deploy-react
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - run: npm run build

      - name: Tar build
        run: tar -czf build.tgz -C build .

      - name: Upload build.tgz to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: build.tgz
          target: /srv/www/react-apps/<app-name>/

      - name: Unpack, release swap, reload NGINX
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /srv/www/react-apps/<app-name>
            mkdir -p releases
            TS=$(date +%Y%m%d%H%M%S)
            mkdir "releases/$TS"
            tar -xzf build.tgz -C "releases/$TS"
            ln -sfn "releases/$TS" build
            chown -R www-data:www-data "releases/$TS" build
            systemctl reload nginx
~~~

**Rollback (with releases):**
~~~bash
cd /srv/www/react-apps/<app-name>
ls -1 releases
ln -sfn releases/<previous-timestamp> build
systemctl reload nginx
~~~

## Optional nginx enhancements

**http to https redirect**
~~~nginx
server {
  listen 80;
  server_name <domain>;
  return 301 https://$host$request_uri;
}
~~~

**Static asset caching and gzip**
~~~nginx
gzip on;
gzip_types text/plain text/css application/javascript application/json image/svg+xml;
location ~* \.(js|css|png|jpg|svg|woff2?)$ { expires 30d; access_log off; }
~~~

## Troubleshooting

| Symptom                               | Likely cause and fix                                         |
|--------------------------------------|---------------------------------------------------------------|
| Refresh on nested routes returns 404 | Missing SPA fallback: `try_files $uri /index.html;`          |
| Certbot fails with NXDOMAIN          | Wrong or absent DNS record at Aruba; wait for propagation    |
| Actions step fails ssh               | Wrong secrets, SSH port blocked, key not in `authorized_keys`|
| White page after deploy              | Build failed or wrong `root` path in NGINX config            |