# React Vite SPA Deployment ‚Äî VPS + NGINX + HTTPS + GitHub Actions

This guide builds and deploys a **React** single-page application (SPA), created with Vite, to a **Linux VPS**, configures **NGINX** for client-side routing, enables **HTTPS** via **Certbot**, sets **Aruba DNS**, and wires **CI/CD** via **GitHub Actions**.

## Recommended vps structure

~~~
/srv/www/
‚îú‚îÄ‚îÄ react-apps/
‚îÇ   ‚îî‚îÄ‚îÄ my-react-app/
‚îÇ       ‚îî‚îÄ‚îÄ dist/          ‚Üê Generated by `npm run build`
‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îî‚îÄ‚îÄ my-react-app/
‚îÇ       ‚îú‚îÄ‚îÄ access.log
‚îÇ       ‚îî‚îÄ‚îÄ error.log
‚îú‚îÄ‚îÄ configs/
    ‚îî‚îÄ‚îÄ nginx/
        ‚îî‚îÄ‚îÄ my-react-app.conf
~~~

## Prerequisites

- Linux VPS (Ubuntu/Debian) with public IP
- Non-root user with `sudo` (e.g., `<deploy-user>`)
- React app in GitHub (CRA/Vite/other SPA; **not SSR**)
- Domain or subdomain on Aruba (e.g., `app.example.com`)

## Prepare the vps node nginx firewall

~~~bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y nginx git curl ufw

# Node.js LTS (example: Node 20)
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# Firewall
sudo ufw allow OpenSSH
sudo ufw allow 'Nginx Full'
sudo ufw --force enable
sudo ufw status
~~~

Create base directories:

~~~bash
sudo mkdir -p /srv/www/react-apps/<app-name>/build
sudo mkdir -p /srv/www/logs/<app-name>
sudo mkdir -p /srv/www/configs/nginx
~~~

## Clone and build the react app

~~~bash
cd /srv/www/react-apps/<app-name>
sudo git clone https://github.com/<your-user>/<repo>.git .
sudo npm ci
sudo npm run build
~~~

Result: production assets in `/srv/www/react-apps/<app-name>/build`.

## Configure nginx for spa routing

Create `/srv/www/configs/nginx/<app-name>.conf`:

~~~nginx
server {
    listen 80;
    server_name <domain>;  # e.g. app.example.com

    root /srv/www/react-apps/<app-name>/build;
    index index.html;

    access_log /srv/www/logs/<app-name>/access.log;
    error_log  /srv/www/logs/<app-name>/error.log;

    # SPA routing: fallback to index.html
    location / {
        try_files $uri /index.html;
    }
}
~~~

Enable and reload:

~~~bash
sudo ln -s /srv/www/configs/nginx/<app-name>.conf /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
~~~

## Point dns on aruba

Add **A** record:

| Type | Host (Name) | Value (IP) |
|-----:|--------------|------------|
|  A   | `app`        | `<VPS-IP>` |

Result: `app.yourdomain.com` ‚Üí `<VPS-IP>`.

## Enable https with certbot

~~~bash
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d <domain>   # e.g. -d app.example.com
~~~

## Fix permissions

~~~bash
sudo chown -R www-data:www-data /srv/www/react-apps/<app-name>/build
sudo chmod -R 755 /srv/www/react-apps/<app-name>/build
~~~

## All in one deploy script

Create `deploy-react-app.sh` (store on VPS or `~/scripts`):

~~~bash
#!/bin/bash
set -euo pipefail

# Usage: deploy-react-app.sh <project-name> <repo-url> <domain> [deploy-user]
if [[ $# -lt 3 || $# -gt 4 ]]; then
  echo "Usage: $0 <project-name> <github-repo-url> <domain> [deploy-user]"
  echo "Example: $0 codexpane https://github.com/tommaso-berti/codexPane.git www.codexpane.tommasoberti.com website-deployer"
  exit 1
fi

PROJECT_NAME="$1"
REPO_URL="$2"
DOMAIN="$3"
DEPLOY_USER="${4-}"                # optional
PROJECT_SLUG="${PROJECT_NAME,,}"

ROOT_DIR="/srv/www/react-apps/$PROJECT_SLUG"
LOG_DIR="/srv/www/logs/$PROJECT_SLUG"
CONF_DIR="/srv/www/configs/nginx"
CONF_FILE="$CONF_DIR/$PROJECT_SLUG.conf"

# Helpers
ensure_deploy_user() {
  [[ -z "$DEPLOY_USER" ]] && return 0
  id -u "$DEPLOY_USER" >/dev/null 2>&1 || adduser --disabled-password --gecos "" "$DEPLOY_USER"
}

setup_sudoers_for_nginx() {
  [[ -z "$DEPLOY_USER" ]] && return 0
  local NGINX_BIN SYSTEMCTL_BIN VISUDO SUDOERS_FILE
  NGINX_BIN="$(command -v nginx || echo /usr/sbin/nginx)"
  SYSTEMCTL_BIN="$(command -v systemctl || echo /usr/bin/systemctl)"
  VISUDO="$(command -v visudo || echo /usr/sbin/visudo)"
  SUDOERS_FILE="/etc/sudoers.d/${DEPLOY_USER}-nginx"
  cat > "$SUDOERS_FILE" <<EOF
Cmnd_Alias NGINX_CMDS = $NGINX_BIN -t, $SYSTEMCTL_BIN reload nginx
$DEPLOY_USER ALL=(root) NOPASSWD: NGINX_CMDS
EOF
  chmod 440 "$SUDOERS_FILE"
  $VISUDO -cf "$SUDOERS_FILE" >/dev/null
}

echo "üìÅ Creating folders..."
mkdir -p "$ROOT_DIR" "$LOG_DIR" "$CONF_DIR"
cd "$ROOT_DIR"

echo "üë§ Ensuring deploy user (if provided)..."
ensure_deploy_user

echo "üîΩ Preparing repository..."
if [[ -d .git ]]; then
  git fetch --all --prune
  DEFAULT_BRANCH="$(git remote show origin | awk '/HEAD branch/ {print $NF}')"
  DEFAULT_BRANCH="${DEFAULT_BRANCH:-main}"
  git reset --hard "origin/$DEFAULT_BRANCH"
  git clean -fdx
else
  if [[ -n "$(ls -A 2>/dev/null || true)" ]]; then
    echo "‚ùå $ROOT_DIR exists but is not a Git repo. Empty or remove it and retry."
    exit 1
  fi
  git clone "$REPO_URL" .
fi

echo "üì¶ Installing dependencies & building..."
if command -v npm >/dev/null 2>&1; then
  npm ci --no-audit --no-fund || npm install
  npm run build
else
  echo "‚ùå npm not found"; exit 1
fi

# Vite => dist, CRA => build
if [[ -d dist ]]; then
  BUILD_DIR="$ROOT_DIR/dist"
elif [[ -d build ]]; then
  BUILD_DIR="$ROOT_DIR/build"
else
  echo "‚ùå Build folder not found (neither dist nor build)"; exit 1
fi

echo "üîê Permissions..."
# NGINX must read files; keep ownership with DEPLOY_USER (or root if none), DO NOT chown to www-data here
chmod -R a+rX "$BUILD_DIR"

# Logs must be writable by nginx
chown -R www-data:www-data "$LOG_DIR"

# If a deploy user is provided, give them ownership of the whole repo (future builds as that user)
if [[ -n "$DEPLOY_USER" ]]; then
  chown -R "$DEPLOY_USER":"$DEPLOY_USER" "$ROOT_DIR"
fi

echo "‚öôÔ∏è Writing NGINX config for $DOMAIN..."
cat > "$CONF_FILE" <<EOF
server {
  listen 80;
  server_name $DOMAIN;

  root $BUILD_DIR;
  index index.html;

  access_log /srv/www/logs/$PROJECT_SLUG/access.log;
  error_log  /srv/www/logs/$PROJECT_SLUG/error.log;

  location / {
    try_files \$uri \$uri/ /index.html;
  }
}
EOF

# Disable default site (if present)
rm -f /etc/nginx/sites-enabled/default || true

# Symlink the site (lowercase slug)
ln -sfn "$CONF_FILE" "/etc/nginx/sites-enabled/${PROJECT_SLUG}.conf"

# If nginx.conf had a hard-coded include, switch it to wildcard once
if grep -q '/etc/nginx/sites-enabled/codexPane.conf' /etc/nginx/nginx.conf 2>/dev/null; then
  sed -i 's|/etc/nginx/sites-enabled/codexPane.conf|/etc/nginx/sites-enabled/*.conf|' /etc/nginx/nginx.conf
fi

echo "üõ°Ô∏è Sudoers for nginx reload (if deploy user provided)..."
setup_sudoers_for_nginx

echo "üöÄ Testing & reloading NGINX..."
nginx -t && systemctl reload nginx

read -r -p "üîí Enable HTTPS with Certbot for $DOMAIN? (y/n): " R
if [[ "$R" =~ ^[Yy]$ ]]; then
  echo "‚ÑπÔ∏è DNS A record (as seen from this server):"
  getent ahostsv4 "$DOMAIN" 2>/dev/null | awk '{print $1}' | sort -u || true
  certbot --nginx --redirect -d "$DOMAIN"
fi

echo "‚úÖ Done. Visit: https://$DOMAIN"
~~~

Make it executable everywhere on the VPS:

~~~bash
chmod +x deploy-react-app.sh
~~~

## Build on the vps

**Generate a deploy SSH key (local):**

~~~bash
ssh-keygen -t rsa -b 4096 -C "github-deploy" -f ~/.ssh/id_rsa_github -N ""
ssh-copy-id -i ~/.ssh/id_rsa_github.pub <deploy-user>@<VPS-IP>
~~~

**GitHub repository secrets:**

- `SSH_PRIVATE_KEY` ‚Üí content of `~/.ssh/id_rsa_github`
- `VPS_HOST` ‚Üí `<VPS-IP>`
- `VPS_USER` ‚Üí `<deploy-user>`

**Workflow** `.github/workflows/deploy.yml`:

~~~yaml
name: Deploy React (Vite build on VPS)
on:
  push:
    branches: [ main ]
concurrency: deploy-react

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Build & deploy on VPS (Vite)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail

            # 1) Vai nella cartella del progetto (gestisci maiuscole)
            cd /srv/www/react-apps/codexpane || cd /srv/www/react-apps/codexPane

            # 2) Allinea il repo in modo pulito
            git fetch --all --prune
            git reset --hard origin/main
            git clean -fdx

            # 3) (facoltativo) stampa versioni per debug
            node -v || true
            npm -v || true

            # 4) Installa e builda (Vite -> dist)
            npm ci --no-audit --no-fund || npm install
            npm run build

            # 5) Permessi cartella dist e reload NGINX
            test -d dist && chown -R www-data:www-data dist
            nginx -t && systemctl reload nginx
~~~

**Pros:** minimal setup. **Cons:** build depends on VPS toolchain.

## Build in ci upload artifacts

**Same SSH key + secrets as above.**

**Workflow** `.github/workflows/deploy.yml`:

~~~yaml
name: Deploy React (build in CI)
on:
  push:
    branches: [ main ]
concurrency: deploy-react
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - run: npm run build

      - name: Tar build
        run: tar -czf build.tgz -C build .

      - name: Upload build.tgz to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: build.tgz
          target: /srv/www/react-apps/<app-name>/

      - name: Unpack, release swap, reload NGINX
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /srv/www/react-apps/<app-name>
            mkdir -p releases
            TS=$(date +%Y%m%d%H%M%S)
            mkdir "releases/$TS"
            tar -xzf build.tgz -C "releases/$TS"
            ln -sfn "releases/$TS" build
            chown -R www-data:www-data "releases/$TS" build
            systemctl reload nginx
~~~

**Rollback (with releases):**
~~~bash
cd /srv/www/react-apps/<app-name>
ls -1 releases
ln -sfn releases/<previous-timestamp> build
systemctl reload nginx
~~~

## Optional nginx enhancements

**http to https redirect**
~~~nginx
server {
  listen 80;
  server_name <domain>;
  return 301 https://$host$request_uri;
}
~~~

**Static asset caching and gzip**
~~~nginx
gzip on;
gzip_types text/plain text/css application/javascript application/json image/svg+xml;
location ~* \.(js|css|png|jpg|svg|woff2?)$ { expires 30d; access_log off; }
~~~

## Troubleshooting

| Symptom                               | Likely cause and fix                                         |
|--------------------------------------|---------------------------------------------------------------|
| Refresh on nested routes returns 404 | Missing SPA fallback: `try_files $uri /index.html;`          |
| Certbot fails with NXDOMAIN          | Wrong or absent DNS record at Aruba; wait for propagation    |
| Actions step fails ssh               | Wrong secrets, SSH port blocked, key not in `authorized_keys`|
| White page after deploy              | Build failed or wrong `root` path in NGINX config            |