name: Deploy React (Vite build on VPS)

on:
  push:
    branches: ["main"]

concurrency:
  group: deploy-react
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Build & deploy on VPS (Vite)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}   # e.g. website-deployer
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -euo pipefail

            # Avoid "dubious ownership" if the repo was created by another user
            git config --global --add safe.directory /srv/www/react-apps/codexpane || true
            git config --global --add safe.directory /srv/www/react-apps/codexPane || true

            # Go to your app folder (handles both casings)
            cd /srv/www/react-apps/codexpane || cd /srv/www/react-apps/codexPane

            # If you use nvm, load Node 20; otherwise this line is a no-op
            [ -s "$HOME/.nvm/nvm.sh" ] && . "$HOME/.nvm/nvm.sh" && nvm use 20 || true

            # Clean align to main
            git fetch --all --prune
            git reset --hard origin/main
            git clean -fdx

            # Build Vite -> dist
            npm ci --no-audit --no-fund || npm install
            npm run build

            # NGINX only needs read access; do NOT chown here
            chmod -R a+rX dist || true

            # Reload NGINX (requires limited sudo on the server)
            sudo /usr/sbin/nginx -t
            sudo /usr/bin/systemctl reload nginx